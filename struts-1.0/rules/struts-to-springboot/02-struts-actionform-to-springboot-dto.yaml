# Rules for migrating Struts ActionForm to Spring DTOs with Bean Validation

- category: mandatory
  customVariables: []
  description: Replace ActionForm with Spring DTO using Bean Validation
  effort: 4
  labels:
    - konveyor.io/source=struts
    - konveyor.io/target=springboot
  links:
    - title: Spring Web MVC Form Handling
      url: https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-ann-modelattrib-method-args
    - title: Jakarta Bean Validation
      url: https://jakarta.ee/specifications/bean-validation/
  message: |
    Struts `ActionForm` classes must be converted to plain Java DTOs with Bean Validation.
    
    **Class Declaration Changes:**
    
    | Aspect | From (Struts) | To (Spring) |
    |--------|---------------|-------------|
    | Package | Keep original package | Keep original package |
    | Extends | `extends ActionForm` | Remove (plain POJO) |
    | Annotations | None | Bean Validation annotations |
    | Naming | `*Form` | Keep original name |
    
    **Before (Struts ActionForm):**
    ```java
    package com.example.form;
    
    import org.apache.struts.action.*;
    import javax.servlet.http.*;
    
    public class ItemForm extends ActionForm {
        private String id;
        private String name;
        private String price;
        private String email;
    
        public void reset(ActionMapping mapping, HttpServletRequest request) {
            this.id = null;
            this.name = null;
            this.price = "0.00";
        }
    
        public ActionErrors validate(ActionMapping mapping,
                                    HttpServletRequest request) {
            ActionErrors errors = new ActionErrors();
            if (name == null || name.trim().isEmpty()) {
                errors.add("name", new ActionMessage("error.name.required"));
            }
            if (email != null && !email.contains("@")) {
                errors.add("email", new ActionMessage("error.email.invalid"));
            }
            return errors;
        }
        
        // getters and setters
    }
    ```
    
    **After (Spring DTO with Bean Validation):**
    ```java
    package com.example.form;  // Keep original package
    
    import jakarta.validation.constraints.*;
    import java.math.BigDecimal;
    
    public class ItemForm {  // Keep original name
    
        private Long id;  // Use proper type, not String
    
        @NotBlank(message = "Name is required")
        @Size(max = 100, message = "Name cannot exceed 100 characters")
        private String name;
    
        @NotNull(message = "Price is required")
        @DecimalMin(value = "0.0", message = "Price cannot be negative")
        private BigDecimal price = BigDecimal.ZERO;  // Use BigDecimal for money
    
        @Email(message = "Invalid email format")
        private String email;
    
        // Constructor with defaults (replaces reset() method)
        public ItemDTO() {
            this.price = BigDecimal.ZERO;
        }
    
        // Getters and setters only - no reset() or validate() methods
    }
    ```
    
    **Methods to DELETE:**
    - `reset()` - Use constructor defaults or field initialization
    - `validate()` - Replaced by Bean Validation annotations
  ruleID: struts-actionform-00001
  when:
    java.referenced:
      location: INHERITANCE
      pattern: org.apache.struts.action.ActionForm

- category: mandatory
  customVariables: []
  description: Convert String fields to proper types in DTOs
  effort: 2
  labels:
    - konveyor.io/source=struts
    - konveyor.io/target=springboot
  links:
    - title: Spring Type Conversion
      url: https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#core-convert
  message: |
    Struts ActionForms typically use `String` for all fields. Convert to proper Java types.
    
    **Field Type Transformation:**
    
    | String Field Pattern | Target Type | Validation |
    |---------------------|-------------|------------|
    | ID fields (`id`, `*Id`) | `Long` or `UUID` | None |
    | Numeric fields | `Integer`, `Long`, `BigDecimal` | `@Min`, `@Max`, `@DecimalMin` |
    | Boolean flags | `Boolean` | None |
    | Date fields | `LocalDate`, `LocalDateTime` | `@Past`, `@Future` |
    | Email fields | `String` | `@Email` |
    | Enums (type, status) | `Enum` type | None (type-safe) |
    | Money/currency | `BigDecimal` | `@DecimalMin`, `@DecimalMax` |
    
    **Before:**
    ```java
    private String id;           // Actually a Long
    private String amount;       // Actually a BigDecimal
    private String active;       // Actually a Boolean
    private String createDate;   // Actually a LocalDate
    private String accountType;  // Actually an Enum
    ```
    
    **After:**
    ```java
    private Long id;
    
    @DecimalMin(value = "0.0", message = "Amount must be positive")
    private BigDecimal amount;
    
    private Boolean active;
    
    @PastOrPresent(message = "Create date cannot be in the future")
    private LocalDate createDate;
    
    @NotNull(message = "Account type is required")
    private AccountType accountType;  // Enum
    ```
    
    **Benefits:**
    - Type safety at compile time
    - Automatic validation
    - No manual parsing/conversion
    - Cleaner controller code
  ruleID: struts-actionform-00002
  when:
    builtin.filecontent:
      filePattern: ".*Form\\.java"
      pattern: "private\\s+String\\s+(id|amount|balance|price|quantity|count)\\s*;"

- category: mandatory
  customVariables: []
  description: Replace validate() method with Bean Validation annotations
  effort: 3
  labels:
    - konveyor.io/source=struts
    - konveyor.io/target=springboot
  links:
    - title: Bean Validation Constraints
      url: https://jakarta.ee/specifications/bean-validation/3.0/jakarta-bean-validation-spec-3.0.html#builtinconstraints
  message: |
    Replace `ActionForm.validate()` method with Jakarta Bean Validation annotations.
    
    **Validation Mapping:**
    
    | Struts Validation Code | Bean Validation Annotation |
    |------------------------|---------------------------|
    | `if (field == null \|\| field.trim().isEmpty())` | `@NotBlank` |
    | `if (field == null)` | `@NotNull` |
    | `if (field.length() < min)` | `@Size(min=X)` |
    | `if (field.length() > max)` | `@Size(max=X)` |
    | `if (!field.contains("@"))` | `@Email` |
    | `if (Double.parseDouble(field) < 0)` | `@DecimalMin("0.0")` |
    | `if (!Pattern.matches(regex, field))` | `@Pattern(regexp="...")` |
    
    **Before (Struts imperative validation):**
    ```java
    public ActionErrors validate(ActionMapping mapping,
                                HttpServletRequest request) {
        ActionErrors errors = new ActionErrors();
    
        if (name == null || name.trim().isEmpty()) {
            errors.add("name", new ActionMessage("error.name.required"));
        }
    
        if (email != null && !email.isEmpty() && !email.contains("@")) {
            errors.add("email", new ActionMessage("error.email.invalid"));
        }
    
        if (amount != null) {
            try {
                double amt = Double.parseDouble(amount);
                if (amt < 0) {
                    errors.add("amount", new ActionMessage("error.amount.negative"));
                }
            } catch (NumberFormatException e) {
                errors.add("amount", new ActionMessage("error.amount.invalid"));
            }
        }
    
        return errors;
    }
    ```
    
    **After (Spring declarative validation):**
    ```java
    public class ItemDTO {
    
        @NotBlank(message = "{error.name.required}")
        private String name;
    
        @Email(message = "{error.email.invalid}")
        private String email;
    
        @NotNull(message = "Amount is required")
        @DecimalMin(value = "0.0", message = "{error.amount.negative}")
        private BigDecimal amount;
    }
    ```
    
    **Controller usage:**
    ```java
    @PostMapping("/save")
    public String save(@Valid @ModelAttribute ItemDTO item,
                      BindingResult result, Model model) {
        if (result.hasErrors()) {
            return "items/edit";  // Return to form with errors
        }
        // ... process valid item
    }
    ```
  ruleID: struts-actionform-00003
  when:
    java.referenced:
      location: METHOD
      pattern: org.apache.struts.action.ActionForm.validate*

- category: mandatory
  customVariables: []
  description: Remove reset() method - use constructor defaults
  effort: 1
  labels:
    - konveyor.io/source=struts
    - konveyor.io/target=springboot
  links:
    - title: Spring Form Handling
      url: https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-ann-modelattrib-method-args
  message: |
    The `reset()` method from ActionForm is not needed in Spring. Use constructor or field defaults.
    
    **Before (Struts):**
    ```java
    public void reset(ActionMapping mapping, HttpServletRequest request) {
        this.id = null;
        this.name = null;
        this.accountType = "SAVINGS";
        this.balance = "0.00";
        this.active = "true";
    }
    ```
    
    **After (Spring DTO):**
    ```java
    public class AccountDTO {
        private Long id;
        private String name;
        private String accountType = "SAVINGS";        // Field default
        private BigDecimal balance = BigDecimal.ZERO;  // Field default
        private Boolean active = true;                 // Field default
    
        // Or use constructor
        public AccountDTO() {
            this.accountType = "SAVINGS";
            this.balance = BigDecimal.ZERO;
            this.active = true;
        }
    }
    ```
    
    **In controller, use @ModelAttribute for defaults:**
    ```java
    @ModelAttribute("accountDTO")
    public AccountDTO newAccountDTO() {
        AccountDTO dto = new AccountDTO();
        dto.setAccountType("SAVINGS");
        dto.setBalance(BigDecimal.ZERO);
        return dto;
    }
    ```
  ruleID: struts-actionform-00004
  when:
    java.referenced:
      location: IMPORT
      pattern: org.apache.struts.action.ActionForm

- category: mandatory
  customVariables: []
  description: Replace ActionMessage with validation message keys
  effort: 1
  labels:
    - konveyor.io/source=struts
    - konveyor.io/target=springboot
  links:
    - title: Spring MessageSource
      url: https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#context-functionality-messagesource
  message: |
    Replace `ActionMessage` error keys with Bean Validation message placeholders.
    
    **Before (Struts ActionForm):**
    ```java
    errors.add("name", new ActionMessage("error.name.required"));
    errors.add("email", new ActionMessage("error.email.invalid"));
    errors.add("amount", new ActionMessage("error.amount.range", min, max));
    ```
    
    **After (Bean Validation):**
    ```java
    @NotBlank(message = "{error.name.required}")
    private String name;
    
    @Email(message = "{error.email.invalid}")
    private String email;
    
    @DecimalMin(value = "0", message = "{error.amount.min}")
    @DecimalMax(value = "1000000", message = "{error.amount.max}")
    private BigDecimal amount;
    ```
    
    **Messages file** (`messages.properties` or `ValidationMessages.properties`):
    ```properties
    error.name.required=Name is required
    error.email.invalid=Please enter a valid email address
    error.amount.min=Amount must be at least {value}
    error.amount.max=Amount cannot exceed {value}
    ```
    
    **Note:** Bean Validation looks for:
    - `ValidationMessages.properties` (default)
    - Spring also checks `messages.properties`
  ruleID: struts-actionform-00005
  when:
    java.referenced:
      location: IMPORT
      pattern: org.apache.struts.action.ActionMessage

- category: optional
  customVariables: []
  description: Create enum for type fields instead of String
  effort: 2
  labels:
    - konveyor.io/source=struts
    - konveyor.io/target=springboot
  links:
    - title: Java Enums Best Practices
      url: https://docs.oracle.com/javase/tutorial/java/javaOO/enum.html
  message: |
    Replace String fields with limited values using Java enums for type safety.
    
    **Before (String with validation):**
    ```java
    private String accountType;  // "SAVINGS", "CHECKING", "CREDIT"
    
    public ActionErrors validate(...) {
        if (accountType != null &&
            !accountType.equals("SAVINGS") &&
            !accountType.equals("CHECKING") &&
            !accountType.equals("CREDIT")) {
            errors.add("accountType", new ActionMessage("error.accountType.invalid"));
        }
    }
    ```
    
    **After (Enum - type-safe):**
    ```java
    // Define enum
    public enum AccountType {
        SAVINGS, CHECKING, CREDIT
    }
    
    // Use in DTO
    public class AccountDTO {
        @NotNull(message = "Account type is required")
        private AccountType accountType;
    }
    ```
    
    **Benefits:**
    - No validation code needed (invalid values rejected automatically)
    - Compile-time type safety
    - IDE auto-completion
    - Self-documenting code
    
    **Common enum candidates:**
    - Account types (SAVINGS, CHECKING)
    - Status codes (ACTIVE, INACTIVE, PENDING)
    - Transaction types (DEPOSIT, WITHDRAWAL, TRANSFER)
    - Priority levels (HIGH, MEDIUM, LOW)
  ruleID: struts-actionform-00006
  when:
    builtin.filecontent:
      filePattern: ".*Form\\.java"
      pattern: "private\\s+String\\s+(type|status|category|priority)\\s*;"

- category: mandatory
  customVariables: []
  description: Update Action/Controller code to use typed Form fields correctly
  effort: 4
  labels:
    - konveyor.io/source=struts
    - konveyor.io/target=springboot
  links:
    - title: Spring MVC Form Binding
      url: https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-ann-modelattrib-method-args
  message: |
    **CRITICAL: When Form fields change from String to typed fields, ALL code that uses
    those forms MUST be updated.**
    
    When converting ActionForm fields from String to proper types (Long, BigDecimal, Enum),
    the Action/Controller classes that USE these forms must also be updated to work with
    the new types directly - do NOT parse or wrap values that are already typed.
    
    **Common Mistakes to Avoid:**
    
    | Mistake | Why It Fails | Correct Code |
    |---------|--------------|--------------|
    | `Long.parseLong(form.getId())` | `getId()` already returns `Long` | `form.getId()` |
    | `new BigDecimal(form.getAmount())` | `getAmount()` already returns `BigDecimal` | `form.getAmount()` |
    | `form.getId().trim()` | `Long` has no `trim()` method | `form.getId()` |
    | `"DEPOSIT".equals(form.getType())` | `getType()` returns `Enum`, not `String` | `TransactionType.DEPOSIT.equals(form.getType())` or `form.getType() == TransactionType.DEPOSIT` |
    | `account.setType(form.getType())` when types differ | Form uses `Enum`, entity uses `String` | `account.setType(form.getType().name())` |
    
    **Before (Using String-based form - OLD Struts code):**
    ```java
    public ActionForward execute(...) {
        // OLD: Form fields were all Strings, needed parsing
        Long accountId = Long.parseLong(txForm.getAccountId());
        BigDecimal amount = new BigDecimal(txForm.getAmount());
        String transactionType = txForm.getTransactionType();
        
        if ("DEPOSIT".equals(transactionType)) {
            accountDAO.deposit(accountId, amount);
        }
        
        // Check if ID exists
        if (form.getId() != null && !form.getId().trim().isEmpty()) {
            // process existing record
        }
    }
    ```
    
    **After (Using typed form - NEW Spring code):**
    ```java
    @PostMapping("/transaction")
    public String processTransaction(TransactionForm txForm, Model model) {
        // NEW: Form fields are already typed - use directly!
        Long accountId = txForm.getAccountId();           // Already Long
        BigDecimal amount = txForm.getAmount();           // Already BigDecimal
        TransactionType type = txForm.getTransactionType(); // Already Enum
        
        if (TransactionType.DEPOSIT == type) {            // Enum comparison
            accountService.deposit(accountId, amount);
        }
        
        // Check if ID exists (Long comparison)
        if (txForm.getId() != null) {
            // process existing record
        }
    }
    ```
    
    **Type Mapping Summary:**
    
    | Form Field Type | Direct Usage (No Parsing) | Enum to String | String to Enum |
    |-----------------|---------------------------|----------------|----------------|
    | `Long` | `form.getId()` | N/A | N/A |
    | `BigDecimal` | `form.getAmount()` | N/A | N/A |
    | `Enum` | `form.getType()` | `form.getType().name()` | `EnumType.valueOf(str)` |
    
    **Key Points:**
    - Remove all `Long.parseLong()` calls for Long fields
    - Remove all `new BigDecimal()` wrappers for BigDecimal fields
    - Remove all `.trim()` calls on non-String fields
    - Use enum comparison (`==` or `.equals()`) instead of String comparison
    - When setting entity fields from form, ensure type compatibility
  ruleID: struts-actionform-00007
  when:
    or:
      - java.referenced:
          location: IMPORT
          pattern: org.apache.struts.action.ActionForm
      - builtin.filecontent:
          filePattern: ".*Action\\.java"
          pattern: "Long\\.parseLong\\(.*Form\\."
      - builtin.filecontent:
          filePattern: ".*Action\\.java"
          pattern: "new\\s+BigDecimal\\(.*Form\\."

